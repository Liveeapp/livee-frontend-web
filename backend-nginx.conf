user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events { worker_connections 1024; }

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;
  
  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';
  
  access_log /var/log/nginx/access.log main;
  sendfile on;
  keepalive_timeout 65;
  client_max_body_size 100M;

  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss image/svg+xml;

  upstream authentication { server authentication:3001; }
  upstream users           { server users:3002; }
  upstream email_verification { server email-verification:3003; }
  upstream business        { server business:3004; }
  upstream content         { server content:3005; }
  upstream engagements     { server engagements:3006; }
  upstream admin { server admin:3008; }
  
  # NEW: Frontend Admin Dashboard Upstream
  upstream livee_frontend { server livee-frontend-web:3008; }

  # HTTP redirects to HTTPS, keep ACME for renewals
  server {
    listen 80;
    server_name liveeapp.io www.liveeapp.io;
    location /.well-known/acme-challenge/ { root /var/www/certbot; }
    location / { return 301 https://$host$request_uri; }
  }

  # HTTPS server
  server {
    listen 443 ssl;
    http2 on;
    server_name liveeapp.io www.liveeapp.io;

    ssl_certificate     /etc/letsencrypt/live/liveeapp.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/liveeapp.io/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;

    # ============================================
    # NEW: Admin Portal Frontend (React SPA)
    # ============================================
    location /admin-portal/ {
        proxy_pass http://livee_frontend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    location /admin-portal {
        return 301 /admin-portal/;
    }

    # ============================================
    # Existing Backend API Services
    # ============================================
    location /businesses/api     { proxy_pass http://business/api; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /businesses/        { proxy_pass http://business/businesses/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /businesses         { proxy_pass http://business/businesses/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /content/api        { proxy_pass http://content/api; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /content/           { proxy_pass http://content/content/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /content            { proxy_pass http://content/content/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /engagements/api    { proxy_pass http://engagements/api; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /engagements/       { proxy_pass http://engagements/engagements/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /engagements        { proxy_pass http://engagements/engagements/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /auth/api           { proxy_pass http://authentication/api; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /auth/              { proxy_pass http://authentication/auth/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /auth               { proxy_pass http://authentication/auth/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /users/api          { proxy_pass http://users/api; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /users/             { proxy_pass http://users/users/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /users              { proxy_pass http://users/users/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /email-verification/api { proxy_pass http://email_verification/api; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /email-verification/ { proxy_pass http://email_verification/email-verification/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /email-verification { proxy_pass http://email_verification/email-verification/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /admin/api    { proxy_pass http://admin/api; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /admin/       { proxy_pass http://admin/admin/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    location /admin        { proxy_pass http://admin/admin/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    
    location /health { return 200 "ok\n"; }
  }
}
